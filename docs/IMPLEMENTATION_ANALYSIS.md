# 쿠버네티스 노드 격리 방법 구현 분석

## 개요

본 프로젝트는 쿠버네티스 클러스터에서 노드 장애 시 파드 마이그레이션을 테스트하기 위해 5가지 노드 격리 방법을 구현했습니다. 이 문서는 각 방법의 구현 방식과 쿠버네티스 내장 기능 사용 여부를 분석합니다.

## 구현된 격리 방법 분석

### 직접 구현 방법 (시스템 레벨)

#### 1. 네트워크 격리 (method1_network_isolation)
- **구현 방식**: iptables를 사용하여 API 서버 통신 차단
- **기술적 세부사항**:
  - 모든 마스터 노드의 6443 포트(API 서버)로의 OUTPUT 트래픽 차단
  - `iptables -A OUTPUT -d {master_ip} -p tcp --dport 6443 -j DROP`
- **복구 방식**: 지정된 시간 후 자동으로 iptables 규칙 제거
- **쿠버네티스 내장 기능 사용**: 없음 (완전히 시스템 레벨)

#### 2. kubelet 서비스 중지 (method2_kubelet_stop)
- **구현 방식**: systemctl을 사용하여 kubelet 서비스 직접 제어
- **기술적 세부사항**:
  - `systemctl stop kubelet` 명령으로 서비스 중지
  - kubelet이 중지되면 노드가 NotReady 상태로 변경
- **복구 방식**: 지정된 시간 후 `systemctl start kubelet`으로 재시작
- **쿠버네티스 내장 기능 사용**: 없음 (시스템 서비스 제어)

#### 3. 컨테이너 런타임 중지 (method3_container_runtime_stop)
- **구현 방식**: containerd 또는 docker 서비스 직접 중지
- **기술적 세부사항**:
  - 먼저 활성화된 런타임 확인 (`systemctl is-active containerd/docker`)
  - 해당 런타임 서비스 중지 (`systemctl stop {runtime}`)
- **복구 방식**: 지정된 시간 후 런타임 서비스 재시작
- **쿠버네티스 내장 기능 사용**: 없음 (시스템 서비스 제어)

#### 4. 극한 리소스 고갈 (method5_extreme_resource_exhaustion)
- **구현 방식**: stress-ng를 사용하여 메모리 99% 사용
- **기술적 세부사항**:
  - `free -m` 명령으로 사용 가능한 메모리 확인
  - `stress-ng --vm 1 --vm-bytes {memory}M` 명령으로 메모리 고갈
- **복구 방식**: 지정된 시간 후 stress-ng 프로세스 종료
- **쿠버네티스 내장 기능 사용**: 없음 (물리적 리소스 고갈)

### 부분적 쿠버네티스 도구 활용 방법

#### 5. 수동 노드 드레인 (method4_node_drain_manual)
- **구현 방식**: kubectl을 사용하되 표준 drain 명령 대신 커스텀 로직
- **기술적 세부사항**:
  - `kubectl get pods --field-selector spec.nodeName={node}` 로 파드 목록 조회
  - 각 파드를 개별적으로 강제 삭제 (`kubectl delete pod --force --grace-period=0`)
- **표준 drain과의 차이점**:
  - 표준: `kubectl drain {node} --ignore-daemonsets --delete-emptydir-data`
  - 커스텀: 파드별 개별 강제 삭제로 더 급격한 장애 시뮬레이션
- **쿠버네티스 내장 기능 사용**: 부분적 (kubectl 명령 사용하지만 비표준 방식)

## 설계

### 왜 쿠버네티스 내장 기능을 피했는가?

1. **실제 장애 시뮬레이션**: 
   - 표준 `kubectl drain`, `kubectl cordon` 등은 "예상된" 장애 상황
   - 실제 하드웨어 장애나 네트워크 문제는 예상치 못한 방식으로 발생

2. **파드 마이그레이션 테스트의 정확성**:
   - 쿠버네티스가 미리 준비된 상황 vs 갑작스러운 장애 상황의 차이 확인
   - 실제 운영 환경에서 발생할 수 있는 다양한 장애 유형 커버

3. **복구 메커니즘 검증**:
   - 쿠버네티스의 자동 복구 능력 한계 테스트
   - 다양한 장애 시나리오에서의 클러스터 안정성 확인

## 기술적 구현 특징

### SSH 기반 원격 제어
- `sshpass`를 사용한 패스워드 인증
- 모든 노드에 대한 원격 명령 실행 가능
- 백그라운드 프로세스 관리 및 자동 복구

### 자동 복구 메커니즘
- 각 격리 방법마다 지정된 시간 후 자동 복구
- 스레드 기반 비동기 복구 처리
- 사용자 중단 시 즉시 복구 가능

### 환경 설정 중앙화
- YAML 기반 서버 정보 관리
- 노드명 매핑 자동 처리 (isc-worker1 ↔ worker1)
- 확장 가능한 설정 구조

## 결론

본 프로젝트는 쿠버네티스 내장 기능에 의존하지 않고 시스템 레벨에서 직접 노드 격리를 구현함으로써, 실제 운영 환경에서 발생할 수 있는 다양한 장애 상황을 보다 현실적으로 시뮬레이션할 수 있습니다.
이를 통해 쿠버네티스 클러스터의 실제 복원력과 파드 마이그레이션 메커니즘을 정확하게 테스트할 수 있습니다. 