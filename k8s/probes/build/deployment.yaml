apiVersion: apps/v1
kind: Deployment
metadata:
  name: isocontrol-core
  namespace: isocontrol-prod
  labels:
    app: isocontrol
    env: prod
    role: core
spec:
  replicas: 1
  selector:
    matchLabels:
      app: isocontrol
  template:
    metadata:
      labels:
        app: isocontrol
        env: prod
        role: core
    spec:
      containers:
        - name: isocontrol-app
          image: localhost:5001/isocontrol-app:latest
          ports:
            - containerPort: 8080
          env:
            - name: PROBE_LIVENESS_PATH
              value: "/healthz"
            - name: PROBE_READINESS_PATH
              value: "/ready"
            - name: PROBE_STARTUP_PATH
              value: "/startup"
            - name: APP_PORT
              value: "8080"
          livenessProbe:
            httpGet:
              path: /healthz
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 3
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 2
            failureThreshold: 2
          startupProbe:
            httpGet:
              path: /startup
              port: 8080
            failureThreshold: 10
            periodSeconds: 10
          resources:
            limits:
              memory: "512Mi"
              cpu: "500m"
            requests:
              memory: "256Mi"
              cpu: "250m"
        - name: sidecar-monitor
          image: localhost:5001/sidecar-monitor:latest
          env:
            - name: OPERATOR_API
              value: "http://admin-api.isocontrol.svc.cluster.local:8080/alert"
            - name: CHECK_INTERVAL
              value: "20"
          resources:
            limits:
              memory: "128Mi"
              cpu: "100m"
            requests:
              memory: "64Mi"
              cpu: "50m"
        - name: sidecar-latency
          image: localhost:5001/sidecar-latency:latest
          env:
            - name: TARGET_URL
              value: "http://isocontrol-core:8080/healthz"
            - name: OPERATOR_API
              value: "http://admin-api.isocontrol.svc.cluster.local:8080/alert"
            - name: CHECK_INTERVAL
              value: "20"
            - name: LATENCY_THRESHOLD
              value: "500"
          resources:
            limits:
              memory: "128Mi"
              cpu: "100m"
            requests:
              memory: "64Mi"
              cpu: "50m"
# 주의: 운영/테스트 환경 분리, 라벨/네임스페이스/환경변수 일관성 유지
# probe 실패 시 컨테이너 로그 및 sidecar 이벤트 연동 필요
